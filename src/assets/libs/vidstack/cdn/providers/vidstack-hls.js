import{a as f,T as p,l as E,p as T}from"../chunks/vidstack-d7FbT_Ml.js";import{L as g,e as w,i as v}from"../chunks/vidstack-ukgjEQ1O.js";import{VideoProvider as L}from"./vidstack-video.js";import{p as u,D as n,l as k,e as S,k as l,y as C,q as m,W as $}from"../chunks/vidstack-NzoiA7c4.js";import{Q as b,c as A}from"../chunks/vidstack-t8cI5qlS.js";import{R as D}from"../chunks/vidstack-JNT5N8yA.js";import"./vidstack-html.js";import"../chunks/vidstack-nW2KcYUy.js";const I=r=>C(r);class R{constructor(t){this.m=t,this.g=null,this.nd=null,this.od={},this.pd=new Set,this.yk=-1}get instance(){return this.g}setup(t,s){this.b=s;const i=u(s.$state.streamType).includes("live"),o=u(s.$state.streamType).includes("ll-");this.g=new t({lowLatencyMode:o,backBufferLength:o?4:i?8:void 0,renderTextTracksNatively:!1,...this.od});const e=this.Sg.bind(this);for(const a of Object.values(t.Events))this.g.on(a,e);this.g.on(t.Events.ERROR,this.U.bind(this));for(const a of this.pd)a(this.g);s.player.dispatch(new n("hls-instance",{detail:this.g})),this.g.attachMedia(this.m),this.g.on(t.Events.FRAG_LOADING,this.Bk.bind(this)),this.g.on(t.Events.AUDIO_TRACK_SWITCHED,this.Tg.bind(this)),this.g.on(t.Events.LEVEL_SWITCHED,this.Ug.bind(this)),this.g.on(t.Events.LEVEL_LOADED,this.Vg.bind(this)),this.g.on(t.Events.NON_NATIVE_TEXT_TRACKS_FOUND,this.Wg.bind(this)),this.g.on(t.Events.CUES_PARSED,this.Xg.bind(this)),s.qualities[b.Za]=this.Yg.bind(this),k(s.qualities,"change",this.fb.bind(this)),k(s.audioTracks,"change",this.Zg.bind(this)),this.nd=S(this.tt.bind(this))}tt(){if(!this.b.$state.live())return;const t=new D(this.$g.bind(this));return t.Bb(),t.ra.bind(t)}$g(){this.b.$state.liveSyncPosition.set(this.g?.liveSyncPosition??1/0)}Sg(t,s){this.b.player?.dispatch(new n(I(t),{detail:s}))}Wg(t,s){const i=new n(t,{detail:s});let o=-1;for(let e=0;e<s.tracks.length;e++){const a=s.tracks[e],d=a.subtitleTrack??a.closedCaptions,c=new f({id:`hls-${a.kind}${e}`,src:d?.url,label:a.label,language:d?.lang,kind:a.kind});c[p.M]=2,c[p.Ua]=()=>{c.mode==="showing"?(this.g.subtitleTrack=e,o=e):o===e&&(this.g.subtitleTrack=-1,o=-1)},a.default&&c.setMode("showing",i),this.b.textTracks.add(c,i)}}Xg(t,s){const i=this.b.textTracks.getById(`hls-${s.track}`);if(!i)return;const o=new n(t,{detail:s});for(const e of s.cues)e.positionAlign="auto",i.addCue(e,o)}Tg(t,s){const i=this.b.audioTracks[s.id];i&&this.b.audioTracks[g.pa](i,!0,new n(t,{detail:s}))}Ug(t,s){const i=this.b.qualities[s.level];i&&this.b.qualities[g.pa](i,!0,new n(t,{detail:s}))}Vg(t,s){if(this.b.$state.canPlay())return;const{type:i,live:o,totalduration:e,targetduration:a}=s.details,d=new n(t,{detail:s});this.b.delegate.c("stream-type-change",o?i==="EVENT"&&Number.isFinite(e)&&a>=10?"live:dvr":"live":"on-demand",d),this.b.delegate.c("duration-change",e,d);const c=this.g.media;this.g.currentLevel===-1&&this.b.qualities[b.Ya](!0,d);for(const h of this.g.audioTracks)this.b.audioTracks[g.oa]({id:h.id+"",label:h.name,language:h.lang||"",kind:"main"},d);for(const h of this.g.levels)this.b.qualities[g.oa]({id:(h.id??h.height+"p")+"",width:h.width,height:h.height,codec:h.codecSet,bitrate:h.bitrate},d);c.dispatchEvent(new n("canplay",{trigger:d}))}U(t,s){if(s.fatal)switch(s.type){case"networkError":this.Ck(s.error);break;case"mediaError":this.g?.recoverMediaError();break;default:this.Ak(s.error);break}}Bk(){this.yk>=0&&this.zk()}Ck(t){this.zk(),this.g?.startLoad(),this.yk=window.setTimeout(()=>{this.yk=-1,this.Ak(t)},5e3)}zk(){clearTimeout(this.yk),this.yk=-1}Ak(t){this.g?.destroy(),this.g=null,this.b.delegate.c("error",{message:t.message,code:1,error:t})}Yg(){this.g&&(this.g.currentLevel=-1)}fb(){const{qualities:t}=this.b;!this.g||t.auto||(this.g[t.switch+"Level"]=t.selectedIndex,w&&(this.m.currentTime=this.m.currentTime))}Zg(){const{audioTracks:t}=this.b;this.g&&this.g.audioTrack!==t.selectedIndex&&(this.g.audioTrack=t.selectedIndex)}Dk(t){l(t.src)&&(this.zk(),this.g?.loadSource(t.src))}ah(){this.zk(),this.b&&(this.b.qualities[b.Za]=void 0),this.g?.destroy(),this.g=null,this.nd?.(),this.nd=null}}class _{constructor(t,s,i){this.W=t,this.b=s,this.Ca=i,this.bh()}async bh(){const t={onLoadStart:this.Ea.bind(this),onLoaded:this.qd.bind(this),onLoadError:this.ch.bind(this)};let s=await x(this.W,t);if(m(s)&&!l(this.W)&&(s=await q(this.W,t)),!s)return null;if(!s.isSupported()){const i="[vidstack]: `hls.js` is not supported in this environment";return this.b.player.dispatch(new n("hls-unsupported")),this.b.delegate.c("error",{message:i,code:4}),null}return s}Ea(){this.b.player.dispatch(new n("hls-lib-load-start"))}qd(t){this.b.player.dispatch(new n("hls-lib-loaded",{detail:t})),this.Ca(t)}ch(t){const s=A(t);this.b.player.dispatch(new n("hls-lib-load-error",{detail:s})),this.b.delegate.c("error",{message:s.message,code:4,error:s})}}async function q(r,t={}){if(!m(r)){if(t.onLoadStart?.(),r.prototype&&r.prototype!==Function)return t.onLoaded?.(r),r;try{const s=(await r())?.default;if(s&&s.isSupported)t.onLoaded?.(s);else throw Error("");return s}catch(s){t.onLoadError?.(s)}}}async function x(r,t={}){if(l(r)){t.onLoadStart?.();try{if(await E(r),!$(window.Hls))throw Error("");const s=window.Hls;return t.onLoaded?.(s),s}catch(s){t.onLoadError?.(s)}}}const H="https://cdn.jsdelivr.net";class y extends L{constructor(){super(...arguments),this.$$PROVIDER_TYPE="HLS",this.Xe=null,this.d=new R(this.video),this.Gb=`${H}/npm/hls.js@^1.0.0/dist/hls.min.js`}get ctor(){return this.Xe}get instance(){return this.d.instance}get type(){return"hls"}get canLiveSync(){return!0}get config(){return this.d.od}set config(t){this.d.od=t}get library(){return this.Gb}set library(t){this.Gb=t}preconnect(){l(this.Gb)&&T(this.Gb)}setup(t){super.setup(t),new _(this.Gb,t,s=>{this.Xe=s,this.d.setup(s,t),t.delegate.c("provider-setup",this);const i=u(t.$state.source);i&&this.loadSource(i)})}async loadSource(t,s){l(t.src)&&(this.a.preload=s||"",this.d.Dk(t),this.V=t)}onInstance(t){const s=this.d.instance;return s&&t(s),this.d.pd.add(t),()=>this.d.pd.delete(t)}destroy(){this.d.ah()}}y.supported=v();export{y as HLSProvider};
